@layer reset, base, components, utilities;

:root {
  /* Spacing */
  --inline-space: 1ch;
  --block-space: 1rem;

  /* Text */
  --font-sans: -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: "IBM Plex Mono", "JetBrains Mono", ui-monospace, "Cascadia Code", "Fira Code", monospace;

  --text-x-small: 0.7rem;
  --text-small: 0.8rem;
  --text-normal: 0.9rem;
  --text-large: 1.25rem;
  --text-x-large: 1.5rem;

  /* OKLCH colors: Light mode */
  --lch-black: 0% 0 0;
  --lch-white: 100% 0 0;
  --lch-canvas: var(--lch-white);
  --lch-ink-inverted: var(--lch-white);

  --lch-ink-darkest: 26% 0.05 264;
  --lch-ink-darker: 40% 0.026 262;
  --lch-ink-dark: 56% 0.014 260;
  --lch-ink-medium: 66% 0.008 258;
  --lch-ink-light: 84% 0.005 256;
  --lch-ink-lighter: 92% 0.003 254;
  --lch-ink-lightest: 96% 0.002 252;

  --lch-blue-dark: 57.02% 0.1895 260.46;
  --lch-blue-lighter: 92% 0.026 254;

  --lch-green-dark: 55% 0.162 147;
  --lch-red-dark: 59% 0.19 38;

  /* Colors: Named */
  --color-black: oklch(var(--lch-black));
  --color-white: oklch(var(--lch-white));
  --color-canvas: oklch(var(--lch-canvas));
  --color-ink: oklch(var(--lch-ink-darkest));
  --color-ink-dark: oklch(var(--lch-ink-dark));
  --color-ink-medium: oklch(var(--lch-ink-medium));
  --color-ink-light: oklch(var(--lch-ink-light));
  --color-ink-lighter: oklch(var(--lch-ink-lighter));
  --color-ink-lightest: oklch(var(--lch-ink-lightest));
  --color-ink-inverted: oklch(var(--lch-ink-inverted));

  /* Colors: Abstractions */
  --color-link: oklch(var(--lch-blue-dark));
  --color-positive: oklch(var(--lch-green-dark));
  --color-negative: oklch(var(--lch-red-dark));
  --color-selected: oklch(var(--lch-blue-lighter));

  /* Borders & Shadows */
  --border: 1px solid var(--color-ink-lighter);
  --shadow: 0 0 0 1px oklch(var(--lch-black) / 5%),
            0 0.2em 0.2em oklch(var(--lch-black) / 5%),
            0 0.4em 0.4em oklch(var(--lch-black) / 5%),
            0 0.8em 0.8em oklch(var(--lch-black) / 5%);

  /* Focus rings */
  --focus-ring-color: var(--color-link);
  --focus-ring-size: 2px;

  /* Layout */
  --main-padding: clamp(var(--inline-space), 3vw, calc(var(--inline-space) * 3));
  --main-width: 1400px;

  /* Grain */
  --grain-opacity: 0.03;

  @media (prefers-color-scheme: dark) {
    --lch-canvas: 18% 0.04 250;
    --lch-canvas-deep: 12% 0.035 255;
    --lch-ink-inverted: var(--lch-black);

    --lch-ink-darkest: 92% 0.01 250;
    --lch-ink-darker: 80% 0.015 250;
    --lch-ink-dark: 65% 0.02 250;
    --lch-ink-medium: 50% 0.025 250;
    --lch-ink-light: 35% 0.03 250;
    --lch-ink-lighter: 24% 0.035 250;
    --lch-ink-lightest: 20% 0.04 250;

    --lch-blue-dark: 70% 0.14 250;
    --lch-blue-lighter: 25% 0.05 250;

    --lch-green-dark: 75% 0.15 145;
    --lch-red-dark: 70% 0.16 42;

    --shadow: 0 0 0 1px oklch(var(--lch-black) / 0.4),
              0 .2em 1.6em -0.8em oklch(var(--lch-black) / 0.5),
              0 .4em 2.4em -1em oklch(var(--lch-black) / 0.6),
              0 .4em .8em -1.2em oklch(var(--lch-black) / 0.7);

    --grain-opacity: 0.05;
  }
}

@layer reset {
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  body,
  h1,
  h2,
  h3,
  h4,
  p {
    margin: 0;
  }

  summary {
    &::-webkit-details-marker {
      display: none;
    }

    &::marker {
      content: "";
    }
  }
}

@layer base {
  body {
    -webkit-font-smoothing: antialiased;
    background: var(--color-canvas);
    color: var(--color-ink);
    font-family: var(--font-mono);
    font-size: var(--text-normal);
    letter-spacing: -0.01em;
    line-height: 1.5;
    min-height: 100dvh;

    @media (prefers-color-scheme: dark) {
      background: linear-gradient(
        180deg,
        oklch(var(--lch-canvas)) 0%,
        oklch(var(--lch-canvas-deep)) 100%
      );
      background-attachment: fixed;
    }
  }

  /* Film grain overlay */
  body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)'/%3E%3C/svg%3E");
    opacity: var(--grain-opacity);
    mix-blend-mode: overlay;
  }

  a {
    color: var(--color-link);
    text-decoration: none;

    &:hover {
      text-decoration: underline;
    }
  }

  :is(a, button, input) {
    transition: 100ms ease-out;
    transition-property: background-color, border-color, box-shadow, filter;

    &:focus-visible {
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
      outline-offset: 1px;
    }
  }

  ::selection {
    background: var(--color-selected);
  }

  turbo-frame {
    display: contents;
  }
}

@layer components {
  /* Header */
  .page-header {
    align-items: center;
    background-color: var(--color-ink-lightest);
    border-bottom: var(--border);
    display: flex;
    gap: calc(var(--inline-space) * 2);
    justify-content: space-between;
    padding: var(--block-space) calc(var(--inline-space) * 2);
  }

  .header-left {
    align-items: center;
    display: flex;
    gap: var(--inline-space);
  }

  .logotype {
    color: var(--color-ink);
    font-size: var(--text-normal);
    font-weight: 600;
    letter-spacing: 0.05em;
    text-decoration: none;
    text-transform: uppercase;

    &:hover {
      color: var(--color-link);
      text-decoration: none;
    }
  }

  .site-name {
    color: var(--color-positive);
    font-size: var(--text-x-small);
    font-weight: 500;
    letter-spacing: 0.06em;
    margin-right: calc(var(--inline-space) * 2);
    text-transform: uppercase;
  }

  .header-nav {
    align-items: center;
    display: flex;
    flex: 1;
    gap: calc(var(--inline-space) * 3);
  }

  .nav-link {
    align-items: center;
    color: var(--color-ink-dark);
    display: flex;
    font-size: var(--text-x-small);
    font-weight: 500;
    gap: 0.25em;
    letter-spacing: 0.06em;
    text-transform: uppercase;

    &:hover {
      color: var(--color-ink);
    }

    &.active {
      color: var(--color-positive);
    }
  }

  .external-icon {
    font-size: var(--text-x-small);
    opacity: 0.7;
  }

  .user-info {
    align-items: center;
    display: flex;
    gap: var(--inline-space);
  }

  .page-content {
    padding: calc(var(--block-space) * 2);
  }

  /* Typography */
  h1 {
    font-size: var(--text-x-large);
    font-weight: 500;
    letter-spacing: -0.02em;
    margin-bottom: var(--block-space);
    text-transform: uppercase;
  }

  h2 {
    font-size: var(--text-large);
    font-weight: 500;
    letter-spacing: -0.01em;
    margin-bottom: var(--block-space);
  }

  p {
    color: var(--color-ink-dark);
    margin-bottom: calc(var(--block-space) * 1.5);
  }

  /* Buttons */
  .btn {
    background-color: var(--color-ink);
    border-radius: 0.25rem;
    border: 0;
    color: var(--color-ink-inverted);
    cursor: pointer;
    display: inline-flex;
    font-family: inherit;
    font-size: var(--text-x-small);
    font-weight: 500;
    letter-spacing: 0.04em;
    padding: 0.75em 1.5em;
    text-transform: uppercase;

    &:hover {
      background-color: var(--color-link);
      text-decoration: none;
    }
  }

  /* Sign in */
  .sign-in-container {
    align-items: center;
    display: flex;
    justify-content: center;
    min-height: 100dvh;
    padding: var(--block-space);
  }

  .sign-in-box {
    background-color: var(--color-ink-lightest);
    border-radius: 0.25rem;
    border: var(--border);
    box-shadow: var(--shadow);
    max-width: min(400px, 100%);
    padding: calc(var(--block-space) * 3);
    text-align: center;

    h1 {
      font-size: var(--text-x-large);
      margin-bottom: calc(var(--block-space) * 2);
    }

    form {
      display: flex;
      justify-content: center;
    }
  }

  /* Layout */
  .container {
    display: flex;
    gap: calc(var(--inline-space) * 2);
    margin: 0 auto;
    max-width: var(--main-width);
  }

  aside {
    background: var(--color-ink-lightest);
    border-radius: 0.25rem;
    height: fit-content;
    min-width: 180px;
    padding: var(--block-space);

    ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    li {
      margin-bottom: 2px;
    }

    a {
      border-radius: 0.125rem;
      display: block;
      font-size: var(--text-small);
      padding: calc(var(--block-space) / 2);
      transition: background-color 100ms;

      &:hover {
        background-color: var(--color-ink-lighter);
        text-decoration: none;
      }

      &.active {
        background-color: var(--color-ink);
        color: var(--color-ink-inverted);
        font-weight: 500;

        &:hover {
          background-color: var(--color-link);
        }
      }
    }
  }

  main {
    flex: 1;
  }

  /* Tables */
  table {
    background: var(--color-ink-lightest);
    border-collapse: collapse;
    border-radius: 0.25rem;
    box-shadow: var(--shadow);
    overflow: hidden;
    width: 100%;
  }

  thead {
    background: var(--color-ink-lighter);
  }

  th {
    font-size: var(--text-x-small);
    font-weight: 500;
    letter-spacing: 0.08em;
    padding: calc(var(--block-space) * 0.75) var(--block-space);
    text-align: left;
    text-transform: uppercase;
  }

  td {
    border-top: var(--border);
    font-size: var(--text-small);
    padding: calc(var(--block-space) * 0.75) var(--block-space);
  }

  tbody tr {
    cursor: pointer;
    transition: background-color 100ms;

    &:hover {
      background-color: var(--color-canvas);
    }
  }

  /* Map */
  #nodes-map {
    border-radius: 0.25rem;
    box-shadow: var(--shadow);
    height: 400px;
    margin-bottom: calc(var(--block-space) * 2);
    width: 100%;

    .leaflet-tile-pane img {
      max-width: none !important;
    }
  }

  /* Artifact popover */
  .artifact-popover {
    display: inline-block;
    position: relative;

    summary {
      cursor: pointer;
    }

    &[open] > summary {
      color: var(--color-link);
    }

    .artifact-content {
      background: var(--color-ink-lightest);
      border-radius: 0.25rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      height: 80vh;
      left: 50%;
      overflow: hidden;
      position: fixed;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 80vw;
      z-index: 1000;
    }

    .artifact-header {
      align-items: center;
      background: var(--color-ink-lighter);
      border-bottom: var(--border);
      display: flex;
      flex-shrink: 0;
      justify-content: space-between;
      padding: calc(var(--block-space) * 0.75) var(--block-space);
    }

    .artifact-title {
      color: var(--color-ink);
      font-size: var(--text-x-small);
      font-weight: 500;
      letter-spacing: 0.02em;
      margin: 0;
      text-transform: uppercase;
    }

    .artifact-body {
      flex: 1;
      overflow: auto;
      padding: var(--block-space);
    }

    .artifact-body video {
      border-radius: 0.125rem;
      display: block;
    }

    .artifact-body pre {
      background: var(--color-ink-lightest);
      border-radius: 0;
      color: var(--color-ink);
      font-family: var(--font-mono);
      font-size: var(--text-x-small);
      line-height: 1.6;
      margin: calc(var(--block-space) * -1);
      padding: var(--block-space);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    &[open]::before {
      background: oklch(var(--lch-black) / 50%);
      content: "";
      inset: 0;
      position: fixed;
      z-index: 999;
    }

    .artifact-close {
      align-items: center;
      background: transparent;
      border-radius: 0.25rem;
      border: 0;
      color: var(--color-negative);
      cursor: pointer;
      display: flex;
      font-size: 1.25rem;
      font-weight: 300;
      height: 1.5rem;
      justify-content: center;
      line-height: 1;
      padding: 0;
      width: 1.5rem;

      &:hover {
        background: var(--color-negative);
        color: var(--color-canvas);
      }
    }
  }

  td .artifact-popover + .artifact-popover {
    margin-left: calc(var(--inline-space) / 2);
  }

  /* Probe name & target */
  .probe-cell {
    display: flex;
    gap: 0.5em;
  }

  .probe-icon {
    flex-shrink: 0;
  }

  .probe-name {
    font-weight: 500;
  }

  .probe-target {
    color: var(--color-ink-medium);
    font-size: var(--text-x-small);
    margin-top: 0.125em;
  }

  /* Status colors */
  .status-ok {
    color: var(--color-positive);
    font-weight: 500;
  }

  .status-fail,
  .status-error {
    color: var(--color-negative);
    font-weight: 600;
  }

  /* Select inputs */
  .input--select {
    -webkit-appearance: none;
    appearance: none;
    background-color: var(--color-canvas);
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m12 19.5c-.7 0-1.3-.3-1.7-.8l-9.8-11.1c-.7-.8-.6-1.9.2-2.6.8-.6 1.9-.6 2.5.2l8.6 9.8c0 .1.2.1.4 0l8.6-9.8c.7-.8 1.8-.9 2.6-.2s.9 1.8.2 2.6l-9.8 11.1c-.4.5-1.1.8-1.7.8z' fill='%23000'/%3E%3C/svg%3E");
    background-position: center right 0.75em;
    background-repeat: no-repeat;
    background-size: 0.5em;
    border-radius: 0.25rem;
    border: 1px solid var(--color-ink-light);
    color: var(--color-ink);
    cursor: pointer;
    font: inherit;
    font-size: var(--text-x-small);
    padding: 0.5em 1.75em 0.5em 0.75em;
    width: 100%;

    &:hover {
      border-color: var(--color-ink-dark);
    }

    &:focus-visible {
      outline: var(--focus-ring-size) solid var(--focus-ring-color);
      outline-offset: 1px;
    }

    @media (prefers-color-scheme: dark) {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m12 19.5c-.7 0-1.3-.3-1.7-.8l-9.8-11.1c-.7-.8-.6-1.9.2-2.6.8-.6 1.9-.6 2.5.2l8.6 9.8c0 .1.2.1.4 0l8.6-9.8c.7-.8 1.8-.9 2.6-.2s.9 1.8.2 2.6l-9.8 11.1c-.4.5-1.1.8-1.7.8z' fill='%23fff'/%3E%3C/svg%3E");
    }

    option {
      background-color: var(--color-canvas);
      color: var(--color-ink);
    }
  }

  /* Filters bar */
  .filters {
    margin-bottom: calc(var(--block-space) * 1.5);

    form {
      align-items: center;
      display: flex;
      gap: calc(var(--inline-space) * 1.5);
    }

    label {
      color: var(--color-ink-dark);
      font-size: var(--text-small);
      font-weight: 500;
    }

    .input--select {
      width: auto;
    }
  }

  /* Probe results chart */
  .probe-results-chart {
    background: var(--color-ink-lightest);
    border-radius: 0.25rem;
    margin-bottom: calc(var(--block-space) * 1.5);
    padding: var(--block-space);

    circle {
      stroke: none;
    }
  }

  /* Pagination */
  .pagination {
    align-items: center;
    display: flex;
    gap: calc(var(--inline-space) * 2);
    justify-content: center;
    margin-top: calc(var(--block-space) * 2);
  }

  .pagination-prev,
  .pagination-next {
    background: var(--color-ink-lightest);
    border-radius: 0.125rem;
    border: var(--border);
    color: var(--color-ink);
    font-size: var(--text-x-small);
    font-weight: 500;
    letter-spacing: 0.02em;
    padding: 0.5em 1em;
    text-transform: uppercase;

    &:hover:not(.disabled) {
      background: var(--color-ink-lighter);
      text-decoration: none;
    }

    &.disabled {
      color: var(--color-ink-medium);
      cursor: not-allowed;
    }
  }

  .pagination-info {
    color: var(--color-ink-dark);
    font-size: var(--text-small);
  }
}
