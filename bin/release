#!/usr/bin/env bash
set -eu

cd "$(dirname "${BASH_SOURCE[0]}")/.."

VERSION_FILE="lib/upright/version.rb"
GEMSPEC="upright.gemspec"

usage() {
  echo "Usage: bin/release <major|minor|patch|VERSION>"
  echo ""
  echo "Examples:"
  echo "  bin/release patch    # 0.1.0 -> 0.1.1"
  echo "  bin/release minor    # 0.1.0 -> 0.2.0"
  echo "  bin/release major    # 0.1.0 -> 1.0.0"
  echo "  bin/release 2.0.0    # Set specific version"
  exit 1
}

if [ $# -ne 1 ]; then
  usage
fi

current_version=$(grep -oP 'VERSION = "\K[^"]+' "$VERSION_FILE")
echo "Current version: $current_version"

bump_type="$1"

if [[ "$bump_type" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  new_version="$bump_type"
else
  IFS='.' read -r major minor patch <<< "$current_version"

  case "$bump_type" in
    major)
      new_version="$((major + 1)).0.0"
      ;;
    minor)
      new_version="$major.$((minor + 1)).0"
      ;;
    patch)
      new_version="$major.$minor.$((patch + 1))"
      ;;
    *)
      usage
      ;;
  esac
fi

echo "New version: $new_version"
echo ""

read -p "Continue with release? [y/N] " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 1
fi

echo "Updating version..."
sed -i "s/VERSION = \"$current_version\"/VERSION = \"$new_version\"/" "$VERSION_FILE"

echo "Updating Gemfile.lock..."
bundle install --quiet

echo "Building gem..."
gem build "$GEMSPEC"

gem_file="upright-$new_version.gem"

echo "Getting OTP from 1Password..."
otp=$(op item get "RubyGems.org" --account my.1password.com --otp)

echo "Pushing gem..."
gem push "$gem_file" --otp "$otp"

echo "Cleaning up gem file..."
rm "$gem_file"

echo "Committing version bump..."
git add "$VERSION_FILE" Gemfile.lock
git commit -m "Bump version to $new_version"

echo "Creating GitHub release..."
gh release create "v$new_version" --title "v$new_version" --generate-notes

echo ""
echo "Released upright $new_version"
