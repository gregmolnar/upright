#!/usr/bin/env node
// Takes screenshots of the Upright UI for the README.
// Requires: bin/dev running, bin/services running, Playwright installed (npx playwright install chromium)
//
// Usage: bin/screenshots

const { chromium } = require("playwright");
const path = require("path");
const dir = path.join(__dirname, "..", "docs", "screenshots");

const VIEWPORT = { width: 1280, height: 720 };
const BASE = process.env.UPRIGHT_HOST || "app.upright.localhost:3000";
const USERNAME = process.env.UPRIGHT_USER || "admin";
const PASSWORD = process.env.UPRIGHT_PASSWORD || "upright";

async function login(context) {
  const page = await context.newPage();
  await page.goto(`http://${BASE}/session/new`);
  await page.locator("button[type=submit]").click();
  await page.waitForLoadState("networkidle");
  await page.fill('input[name="username"]', USERNAME);
  await page.fill('input[name="password"]', PASSWORD);
  await page.click('input[type="submit"], button[type="submit"]');
  await page.waitForLoadState("networkidle");
  await page.waitForTimeout(1000);
  return page;
}

async function screenshot(page, url, file, { waitMs = 1500 } = {}) {
  if (url) {
    await page.goto(`http://${BASE}${url}`);
    await page.waitForLoadState("networkidle");
    await page.waitForTimeout(waitMs);
  }
  const dest = path.join(dir, file);
  await page.screenshot({ path: dest });
  console.log(`  ${file}`);
}

(async () => {
  const browser = await chromium.launch({ channel: "chromium" });

  console.log("Light mode:");
  const light = await browser.newContext({ viewport: VIEWPORT, colorScheme: "light" });
  const lightPage = await login(light);
  await screenshot(lightPage, null, "dashboard.png");
  await screenshot(lightPage, "/dashboards/probe_status", "probe-status.png");
  await light.close();

  console.log("Dark mode:");
  const dark = await browser.newContext({ viewport: VIEWPORT, colorScheme: "dark" });
  const darkPage = await login(dark);
  await screenshot(darkPage, "/dashboards/uptime", "uptime.png");
  await dark.close();

  await browser.close();
  console.log("Done.");
})().catch((e) => {
  console.error(e);
  process.exit(1);
});
