# Upright Kamal Configuration
# Deploy with: bin/kamal deploy

service: <%= app_name %>
image: <%= app_name %>/<%= app_name %>

servers:
  web:
    hosts:
      - <%= app_domain %>: [london]
      # Add more sites:
      # - nyc.<%= app_domain %>: [new_york]
      # - sfo.<%= app_domain %>: [san_francisco]
  jobs:
    hosts:
      - <%= app_domain %>: [london]
      # Add more sites:
      # - nyc.<%= app_domain %>: [new_york]
      # - sfo.<%= app_domain %>: [san_francisco]
    cmd: bin/jobs

ssh:
  user: app

registry:
  server: ghcr.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64
  secrets:
    - GITHUB_TOKEN

proxy:
  app_port: 3000
  ssl: true
  hosts:
    - "*.<%= app_domain %>"

env:
  clear:
    OTEL_EXPORTER_OTLP_ENDPOINT: http://<%= app_name %>-otel_collector:4318/v1/traces
  secret:
    - RAILS_MASTER_KEY
    - PROMETHEUS_OTLP_TOKEN
  tags:
    london:
      SITE_SUBDOMAIN: lon
    # Add more sites:
    # new_york:
    #   SITE_SUBDOMAIN: nyc
    # san_francisco:
    #   SITE_SUBDOMAIN: sfo

volumes:
  - "<%= app_name %>_storage:/rails/storage"

accessories:
  otel_collector:
    image: otel/opentelemetry-collector-contrib:0.126.0
    env:
      secret:
        - OTEL_GATEWAY_USERNAME
        - OTEL_GATEWAY_PASSWORD
        - OTEL_GATEWAY_AUTH
        - PROMETHEUS_OTLP_TOKEN
    files:
      - config/otel_collector.yml:/etc/otelcol-contrib/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers
    options:
      user: 0
    roles:
      - jobs

  playwright:
    image: jacoblincool/playwright:chromium-server-1.55.0
    port: "127.0.0.1:53333:53333"
    roles:
      - jobs

  prometheus:
    image: prom/prometheus:v3.2.1
    hosts:
      - <%= app_domain %>
    cmd: >-
      --config.file=/etc/prometheus/prometheus.yml
      --storage.tsdb.path=/prometheus
      --storage.tsdb.retention.time=24h
      --web.enable-otlp-receiver
      --web.enable-lifecycle
    files:
      - config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - config/prometheus/rules/upright.rules.yml:/etc/prometheus/rules/upright.rules.yml
    volumes:
      - prometheus_data:/prometheus

  alertmanager:
    image: prom/alertmanager:v0.28.1
    hosts:
      - <%= app_domain %>
    cmd: --config.file=/etc/alertmanager/alertmanager.yml
    files:
      - config/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    volumes:
      - alertmanager_data:/alertmanager

aliases:
  console: app exec -i "bin/rails console"
  logs: app logs -f

retain_containers: 3
